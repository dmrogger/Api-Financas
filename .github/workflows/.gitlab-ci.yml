stages:
  - restore
  - build
  - test
  - sonar
  - quality

variables:
  DOTNET_VERSION: "8.0"
  SONAR_HOST_URL: "https://sonarcloud.io"
  SONAR_PROJECT_KEY: "dmrogger_Api-Financas"   
  SONAR_ORGANIZATION: "dmrogger"              
  SONAR_TOKEN: $SONAR_TOKEN                           

default:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  before_script:
    - dotnet --version

restore:
  stage: restore
  script:
    - dotnet restore ApiFinancas.sln
  cache:
    key: "nuget-cache"
    paths:
      - ~/.nuget/packages/
  only:
    - merge_requests
    - main
    - develop

build:
  stage: build
  script:
    - dotnet build ApiFinancas.sln --configuration Release --no-restore
  only:
    - merge_requests
    - main
    - develop

tests:
  stage: test
  script:
    - dotnet test ApiFinancas.Tests/ApiFinancas.Tests.csproj \
        /p:CollectCoverage=true \
        /p:CoverletOutputFormat=cobertura \
        /p:CoverletOutput=./coverage/
  artifacts:
    paths:
      - ApiFinancas.Tests/coverage/coverage.cobertura.xml
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

sonar:
  stage: sonar
  script:
    - dotnet tool install --global dotnet-sonarscanner
    - export PATH="$PATH:/root/.dotnet/tools"

    - dotnet sonarscanner begin \
        /k:"$SONAR_PROJECT_KEY" \
        /o:"$SONAR_ORGANIZATION" \
        /d:sonar.host.url="$SONAR_HOST_URL" \
        /d:sonar.login="$SONAR_TOKEN" \
        /d:sonar.cs.opencover.reportsPaths="**/coverage.cobertura.xml"

    - dotnet build ApiFinancas.sln --configuration Release --no-restore

    - dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"
  dependencies:
    - tests
  only:
    - merge_requests
    - main
    - develop

quality_gate:
  stage: quality
  script: |
    STATUS=$(curl -s -u $SONAR_TOKEN: "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$SONAR_PROJECT_KEY" | jq -r '.projectStatus.status')
    echo "Quality Gate Status: $STATUS"
    if [ "$STATUS" != "OK" ]; then
      echo "❌ Quality Gate falhou!"
      exit 1
    fi
    echo "✅ Quality Gate aprovado!"
  only:
    - merge_requests
    - main
